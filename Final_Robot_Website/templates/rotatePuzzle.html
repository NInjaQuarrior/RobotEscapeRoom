<!DOCTYPE html>
<html lang="en">

<head>
  <link rel="stylesheet" href='/static/sidebar.css'>
  <link rel="stylesheet" href='/static/rotatePuzzle.css'>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.js" type="text/javascript"> </script>
  <meta charset="UTF-8">
  <title>Electrical Grid Projection</title>
</head>

<body onload="startConnect()">

  <!-- ----------- HEADERS ----------- -->
  <title> MQP - Robot Escape Room </title>
  <h1> Electrical Grid Projection </h1>

  <!-- ----------- BUTTONS ----------- -->
  <!-- <button class="sidebarButton" type="button" id="homeButton" onclick=window.location="{{ url_for('main') }}"> <img
      src="static/Images/Home.png"></button>

  <button class="sidebarButton" type="button" id="progressButton" onclick=window.location="{{ url_for('progress') }}">
    <img src="static/Images/Progress.png"></button>

  <button class="sidebarButton" type="button" id="lockButton" onclick=window.location="{{ url_for('hint') }}"> <img
      src="static/Images/Hint.png"></button>

  <button class="sidebarButton" type="button" id="settingsButton" onclick=window.location="{{ url_for('settings') }}">
    <img src="static/Images/Settings.png"></button>

  <button class="sidebarButton" type="button" id="infoButton" onclick=window.location="{{ url_for('manual') }}"> <img
      src="static/Images/Info.png"></button> -->

  <script>
    // Creating a new client instance 
    clientID = "website_rotate_puzzle";
    host = "mqtt.eclipseprojects.io";
    port = 80;
    client = new Paho.MQTT.Client(host, Number(port), clientID);

    function startConnect() {
      client.onMessageArrived = onMessageArrived;
      client.connect({
        onSuccess: onConnect
      });
      puzzle_setup();
    }

    function onConnect() {
      client.subscribe("robot/test");
      client.subscribe("robot/aruco");
      console.log("successfully connected to topics.");
      publishMessage("robot/function", "disable move");
    }

    function onMessageArrived(msg) {
      console.log("OnMessageArrived: " + msg.payloadString + "\tfrom Topic: " + msg.destinationName);
      //alert(message.payloadString);
    }

    function publishMessage(topic, msg) {
      Message = new Paho.MQTT.Message(msg);
      Message.destinationName = topic;

      client.send(Message);
      console.log("topic: " + topic + "\tmsg: " + msg);
    }

    function puzzle_setup() {
      // generate a random degree value between 0 and 359
      console.log("in puzzle_setup()"); 
      const startDegrees = [90, 180, 270];
      const allDegrees = [0, 90, 180, 270];
      let randomDegree = startDegrees[Math.floor(Math.random() * startDegrees.length)];
      //var randomDegree = Math.floor(Math.random() * 360);

      // set the value of the --rotation-degree variable to the random degree value
      document.documentElement.style.setProperty('--rotation-degree', randomDegree + 'deg');
    };

  </script>

  <!--Centered Image Startwidth=25% height=25%-->

  <div class="container">
    <div class="center">

      <!--<img width="400" src="https://www.hubspot.com/hubfs/image-hubspot-centering-css.jpeg">-->
      <!--Centered Image End-->
      <!--<div id="puzzle3"> </div>-->
      <style>
        :root {
          --rotation-degree: 90deg;
          /* set the default rotation degree, make sure it doesn't start at a multiple of 360deg */
        }

        .imageSizing {
          width: 20%;
          height: 20%;
          transform: rotate(var(--rotation-degree));
        }
      </style>
      <img class="imageSizing" id="wp1" onclick="style.transform += 'rotate(90deg)'"
        src="static/wirePuzzleImages/wire-puzzle-for-mqp_01.jpg"> </img>
      <img class="imageSizing" id="wp2" onclick="style.transform += 'rotate(90deg)'"
        src="static/wirePuzzleImages/wire-puzzle-for-mqp_02.gif"> </img>
      <img class="imageSizing" id="wp3" onclick="style.transform += 'rotate(90deg)'"
        src="static/wirePuzzleImages/wire-puzzle-for-mqp_03.gif"> </img>
      <img class="imageSizing" id="wp4" onclick="style.transform += 'rotate(90deg)'"
        src="static/wirePuzzleImages/wire-puzzle-for-mqp_04.gif"> </img>
      <img class="imageSizing" id="wp5" onclick="style.transform += 'rotate(90deg)'"
        src="static/wirePuzzleImages/wire-puzzle-for-mqp_05.gif"> </img>
      <img class="imageSizing" id="wp6" onclick="style.transform += 'rotate(90deg)'"
        src="static/wirePuzzleImages/wire-puzzle-for-mqp_06.gif"> </img>
      <img class="imageSizing" id="wp7" onclick="style.transform += 'rotate(90deg)'"
        src="static/wirePuzzleImages/wire-puzzle-for-mqp_07.gif"> </img>
      <img class="imageSizing" id="wp8" onclick="style.transform += 'rotate(90deg)'"
        src="static/wirePuzzleImages/wire-puzzle-for-mqp_08.gif"> </img>
      <img class="imageSizing" id="wp9" onclick="style.transform += 'rotate(90deg)'"
        src="static/wirePuzzleImages/wire-puzzle-for-mqp_09.gif"> </img>
      <img class="imageSizing" id="wp10" onclick="style.transform += 'rotate(90deg)'"
        src="static/wirePuzzleImages/wire-puzzle-for-mqp_10.gif"> </img>
      <img class="imageSizing" id="wp11" onclick="style.transform += 'rotate(90deg)'"
        src="static/wirePuzzleImages/wire-puzzle-for-mqp_11.gif"> </img>
      <img class="imageSizing" id="wp12" onclick="style.transform += 'rotate(90deg)'"
        src="static/wirePuzzleImages/wire-puzzle-for-mqp_12.gif"> </img>
      <img class="imageSizing" id="wp13" onclick="style.transform += 'rotate(90deg)'"
        src="static/wirePuzzleImages/wire-puzzle-for-mqp_13.gif"> </img>
      <img class="imageSizing" id="wp14" onclick="style.transform += 'rotate(90deg)'"
        src="static/wirePuzzleImages/wire-puzzle-for-mqp_14.gif"> </img>
      <img class="imageSizing" id="wp15" onclick="style.transform += 'rotate(90deg)'"
        src="static/wirePuzzleImages/wire-puzzle-for-mqp_15.gif"> </img>
      <img class="imageSizing" id="wp16" onclick="style.transform += 'rotate(90deg)'"
        src="static/wirePuzzleImages/wire-puzzle-for-mqp_16.gif"> </img>

    </div>
  </div>

  <script>
    let images = document.getElementsByTagName('img'); // get all img elements on the page
    let allRotated = false; // assume not all images are rotated to a multiple of 360 degrees

    function checkRotations() {
      allRotated = true; // assume all images are rotated to a multiple of 360 degrees

      for (let i = 0; i < images.length; i++) {
        let transform = window.getComputedStyle(images[i]).getPropertyValue('transform'); // get the transform property value of the current image
        let matrix = new DOMMatrix(transform); // create a matrix object from the transform property value

        if (matrix.a !== 1 || matrix.b !== 0 || matrix.c !== 0 || matrix.d !== 1) { // check if the matrix values indicate that the image is not rotated to a multiple of 360 degrees
          allRotated = false; // set the allRotated variable to false
          break; // exit the loop if we find an image that is not rotated to a multiple of 360 degrees
        }
      }

      if (allRotated) { // check if all images are rotated to a multiple of 360 degrees
        publishMessage("website/status", "puzzle 3 completed.");
        window.location.href = "{{ url_for('win') }}"; // transition to a different page in the same directory
        localStorage.setItem("curr_puzzle", 4);
        setTimeout(() => { console.log("this should be the end"); }, 5000);
      } else {
        setTimeout(checkRotations, 1000); // call the checkRotations() function again after a 1-second delay
      }
    }

    checkRotations(); // run the initial check for rotated images
  </script>

</body>

</html>